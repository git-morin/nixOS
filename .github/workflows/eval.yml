name: Evaluate NixOS Configurations
on:
  push:
    branches:
      - main

env:
  HOME: /home/runner

jobs:
  evaluate:
    runs-on: self-hosted
    steps:
      - name: ðŸ  Set up environment
        run: |
          echo "HOME=${HOME:-/tmp/runner-home}" >> $GITHUB_ENV
          echo "USER=${USER:-runner}" >> $GITHUB_ENV
          mkdir -p "${HOME:-/tmp/runner-home}"
          echo "Environment setup complete:"
          echo "HOME: ${HOME:-/tmp/runner-home}"
          echo "USER: ${USER:-runner}"

      - name: ðŸ§¹ Clean up previous Nix installation remnants
        run: |
          echo "=== Cleaning up previous Nix installation remnants ==="
          
          # Stop any running Nix daemon
          echo "Stopping Nix daemon if running..."
          sudo systemctl stop nix-daemon || true
          sudo pkill -f nix-daemon || true
          
          # Kill any Nix processes
          echo "Killing any remaining Nix processes..."
          sudo pkill -f "nix " || true
          sudo pkill -f "nix-" || true
          
          # Wait a moment for processes to terminate
          sleep 2
          
          # Remove backup files that prevent reinstallation
          echo "Removing backup files..."
          sudo rm -f /etc/bash.bashrc.backup-before-nix || true
          sudo rm -f /etc/bashrc.backup-before-nix || true
          sudo rm -f /etc/zshrc.backup-before-nix || true
          sudo rm -f /etc/profile.backup-before-nix || true
          
          # Clean up daemon socket and other runtime files
          echo "Cleaning up runtime files..."
          sudo rm -rf /nix/var/nix/daemon-socket || true
          sudo rm -rf /nix/var/nix/profiles/per-user/*/profile* || true
          
          # Check if we can run nix commands
          if command -v nix >/dev/null 2>&1 && nix --version >/dev/null 2>&1; then
            echo "Nix is already installed and working"
            nix --version
            echo "NIX_INSTALL_SKIP=true" >> $GITHUB_ENV
          else
            echo "Nix not found or not working, will install"
            echo "NIX_INSTALL_SKIP=false" >> $GITHUB_ENV
          fi

      - name: ðŸ› Debug environment
        run: |
          echo "Current user: $(whoami)"
          echo "HOME: ${HOME:-'NOT SET'}"
          echo "PWD: $PWD"
          echo "Available space:"
          df -h

      - name: ðŸŒ± Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Cache Nix store
        uses: actions/cache@v3
        with:
          path: |
            /nix/store
            ~/.cache/nix
            ~/.local/state/nix
          key: nix-eval-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-keys: |
            nix-eval-${{ runner.os }}-

      - name: â„ï¸ Install Nix
        if: env.NIX_INSTALL_SKIP != 'true'
        uses: cachix/install-nix-action@v22
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            max-jobs = 1
            cores = 1
        env:
          HOME: ${{ env.HOME }}

      - name: â„ï¸ Configure existing Nix
        if: env.NIX_INSTALL_SKIP == 'true'
        run: |
          echo "Configuring existing Nix installation"
          mkdir -p $HOME/.config/nix
          cat > $HOME/.config/nix/nix.conf << EOF
          experimental-features = nix-command flakes
          max-jobs = 1
          cores = 1
          EOF
          echo "Nix configuration updated"

      - name: ðŸ§ª Show available outputs
        run: |
          echo "=== Available flake outputs ==="
          nix flake show

      - name: ðŸ–¥ï¸ Evaluate NixOS configurations
        run: |
          echo "=== Evaluating main configuration ==="
          nix eval .#nixosConfigurations.main.config.system.build.toplevel.drvPath
          echo "âœ… Main configuration evaluation successful"
          
          echo "=== Evaluating WSL configuration ==="
          nix eval .#nixosConfigurations.wsl.config.system.build.toplevel.drvPath
          echo "âœ… WSL configuration evaluation successful"
          
          echo "=== Evaluating Proxmox configuration ==="
          nix eval .#nixosConfigurations.proxmox.config.system.build.toplevel.drvPath
          echo "âœ… Proxmox configuration evaluation successful"

      - name: ðŸ“‹ Show derivation details
        run: |
          echo "=== Main configuration derivation ==="
          nix show-derivation .#nixosConfigurations.main.config.system.build.toplevel | head -20
          
          echo "=== WSL configuration derivation ==="
          nix show-derivation .#nixosConfigurations.wsl.config.system.build.toplevel | head -20
          
          echo "=== Proxmox configuration derivation ==="
          nix show-derivation .#nixosConfigurations.proxmox.config.system.build.toplevel | head -20

      - name: ðŸ” Check for evaluation issues
        run: |
          echo "=== Checking for evaluation issues ==="
          nix flake check --no-build || echo "Flake check found issues (this is expected for evaluation-only)"
          
          echo "=== List available flake outputs ==="
          nix eval --json .#nixosConfigurations --apply builtins.attrNames || echo "Could not list nixosConfigurations"
          
          echo "=== Verify flake inputs ==="
          nix flake metadata

      - name: ðŸ§ª Additional validation
        run: |
          echo "=== Test configuration instantiation ==="
          nix-instantiate --expr 'let flake = builtins.getFlake (toString ./.); in flake.nixosConfigurations.main.config.system.build.toplevel' || echo "Main config instantiation failed"
          nix-instantiate --expr 'let flake = builtins.getFlake (toString ./.); in flake.nixosConfigurations.wsl.config.system.build.toplevel' || echo "WSL config instantiation failed"
          nix-instantiate --expr 'let flake = builtins.getFlake (toString ./.); in flake.nixosConfigurations.proxmox.config.system.build.toplevel' || echo "Proxmox config instantiation failed"

      - name: ðŸ“Š Show disk usage
        run: |
          echo "=== Final disk usage ==="
          df -h
          echo "=== Nix store size ==="
          du -sh /nix/store 2>/dev/null || echo "Could not measure /nix/store"